<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TL;DR - Intelligent Summaries</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="container">
        <div class="card">
            <div class="header">
                <h1>TL;DR</h1>
                <p>Where conversations, videos, and text become actions...</p>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn {% if default_tab == 'audio' or not default_tab %}active{% endif %}" data-tab="audio">Audio</button>
                <button class="tab-btn {% if default_tab == 'video' %}active{% endif %}" data-tab="video">Video</button>
                <button class="tab-btn {% if default_tab == 'text' %}active{% endif %}" data-tab="text">Text</button>
            </div>

            <div class="tab-content {% if default_tab == 'audio' or not default_tab %}active{% endif %}" id="audio">
                <form class="upload-form" action="/upload_audio" method="post" enctype="multipart/form-data">
                    <label for="audio_file" class="file-label">
                        <div>
                            <span>Click to upload an audio file</span>
                            <p>.mp3, .wav, .m4a</p>
                        </div>
                    </label>
                    <input type="file" name="audio_file" id="audio_file" class="file-input" accept="audio/*" required>
                    <input type="submit" value="Summarize Audio" class="submit-btn">
                </form>

                {% if default_tab == 'audio' and summary_data %}
                <div class="card results-card">
                    <h2>Audio Summary</h2>
                    <p>{{ summary_data.summary }}</p>

                    {% if summary_data.decisions %}
                        <h2>Key Decisions</h2>
                        <ul>
                            {% for decision in summary_data.decisions %}
                                <li>{{ decision }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}

                    {% if summary_data.action_items %}
                        <h2>Action Items</h2>
                        <ul>
                            {% for item in summary_data.action_items %}
                                <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    
                    <div class="transcript-qa-section">
                        <button type="button" class="collapsible">Show Transcript</button>
                        <div class="content transcript-content">
                            <pre>{{ transcript }}</pre>
                        </div>
                        <div id="transcript-data-{{ default_tab }}" style="display: none;">{{ transcript }}</div>
                        <div class="qa-form">
                            <h3>Ask a Question</h3>
                            <p>Ask a question based on the transcript above.</p>
                            <input type="text" id="question_input-{{ default_tab }}" class="qa-input" placeholder="e.g., 'What was the final decision?'">
                            <button type="button" class="submit-btn qa-btn" data-tab-id="{{ default_tab }}">Ask</button>
                            <div id="answer_display-{{ default_tab }}" class="qa-answer"></div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="tab-content {% if default_tab == 'video' %}active{% endif %}" id="video">
                <form class="upload-form" action="/upload_video" method="post" enctype="multipart/form-data">
                    <label for="video_file" class="file-label">
                        <div>
                            <span>Click to upload a video file</span>
                            <p>.mp4, .mov, .avi</p>
                        </div>
                    </label>
                    <input type="file" name="video_file" id="video_file" class="file-input" accept="video/*" required>
                    <input type="submit" value="Summarize Video" class="submit-btn">
                </form>

                {% if default_tab == 'video' and summary_data %}
                <div class="card results-card">
                    <h2>Video Summary</h2>
                    <p>{{ summary_data.summary }}</p>
                    {% if summary_data.decisions %}
                        <h2>Key Decisions</h2>
                        <ul>
                            {% for decision in summary_data.decisions %}
                                <li>{{ decision }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    {% if summary_data.action_items %}
                        <h2>Action Items</h2>
                        <ul>
                            {% for item in summary_data.action_items %}
                                <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    
                    <div class="transcript-qa-section">
                        <button type="button" class="collapsible">Show Transcript</button>
                        <div class="content transcript-content">
                            <pre>{{ transcript }}</pre>
                        </div>
                        <div id="transcript-data-{{ default_tab }}" style="display: none;">{{ transcript }}</div>
                        <div class="qa-form">
                            <h3>Ask a Question</h3>
                            <p>Ask a question based on the transcript above.</p>
                            <input type="text" id="question_input-{{ default_tab }}" class="qa-input" placeholder="e.g., 'What was the final decision?'">
                            <button type="button" class="submit-btn qa-btn" data-tab-id="{{ default_tab }}">Ask</button>
                            <div id="answer_display-{{ default_tab }}" class="qa-answer"></div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="tab-content {% if default_tab == 'text' %}active{% endif %}" id="text">
                <form class="upload-form" action="/summarize_text" method="post">
                    <label for="text_input" class="sr-only">Text to summarize</label>
                    <textarea name="text_input" id="text_input" class="text-input" placeholder="Paste your full transcript or text here...">{{ transcript if default_tab == 'text' else '' }}</textarea>
                    <input type="submit" value="Summarize Text" class="submit-btn">
                </form>

                {% if default_tab == 'text' and summary_data %}
                <div class="card results-card">
                    <h2>Text Summary</h2>
                    <p>{{ summary_data.summary }}</p>
                    {% if summary_data.decisions %}
                        <h2>Key Decisions</h2>
                        <ul>
                            {% for decision in summary_data.decisions %}
                                <li>{{ decision }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    {% if summary_data.action_items %}
                        <h2>Action Items</h2>
                        <ul>
                            {% for item in summary_data.action_items %}
                                <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                {% endif %}
            </div>

        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Tab switching
            const tabButtons = document.querySelectorAll(".tab-btn");
            const tabContents = document.querySelectorAll(".tab-content");
            const defaultTab = '{{ default_tab | default("audio") }}';

            // --- THIS IS THE CORRECTED, ROBUST FUNCTION ---
            function openTab(tabName) {
                // First, remove 'active' from all tabs and content
                tabContents.forEach(content => {
                    content.classList.remove("active");
                });
                tabButtons.forEach(button => {
                    button.classList.remove("active");
                });

                // Find the new content tab to activate
                const contentToActivate = document.getElementById(tabName);
                if (contentToActivate) {
                    contentToActivate.classList.add("active");
                } else {
                    console.error("Could not find tab content with id:", tabName);
                }

                // Find the new button to activate
                const buttonToActivate = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
                if (buttonToActivate) {
                    buttonToActivate.classList.add("active");
                } else {
                    console.error("Could not find tab button with data-tab:", tabName);
                }
            }

            // Set the correct tab active on page load
            openTab(defaultTab);

            // Add click listeners to buttons
            tabButtons.forEach(button => {
                button.addEventListener("click", () => {
                    openTab(button.dataset.tab);
                });
            });

            // Collapsible Transcript Toggle
            const collapsibles = document.querySelectorAll(".collapsible");
            collapsibles.forEach(button => {
                button.addEventListener("click", function() {
                    this.classList.toggle("active");
                    const content = this.nextElementSibling; 
                    if (content.style.display === "block") {
                        content.style.display = "none";
                        this.textContent = "Show Transcript";
                    } else {
                        content.style.display = "block";
                        this.textContent = "Hide Transcript";
                    }
                });
            });

            // Q&A "Ask" Button
            const qaButtons = document.querySelectorAll(".qa-btn");
            qaButtons.forEach(button => {
                button.addEventListener("click", function() {
                    const tabId = this.dataset.tabId;
                    const questionInput = document.getElementById(`question_input-${tabId}`);
                    const transcriptData = document.getElementById(`transcript-data-${tabId}`);
                    const answerDisplay = document.getElementById(`answer_display-${tabId}`);

                    const question = questionInput.value;
                    const transcript = transcriptData.textContent;

                    if (!question.trim()) {
                        answerDisplay.textContent = "Please enter a question.";
                        answerDisplay.style.color = '#d93025';
                        answerDisplay.style.display = 'block';
                        return;
                    }

                    answerDisplay.textContent = "Asking Gemini...";
                    answerDisplay.style.color = '#606770';
                    answerDisplay.style.display = 'block';

                    fetch('/ask_question', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            transcript: transcript,
                            question: question
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            answerDisplay.textContent = `Error: ${data.error}`;
                            answerDisplay.style.color = '#d90000'; // Made error color more prominent
                        } else {
                            answerDisplay.innerHTML = data.answer.replace(/\n/g, '<br>');
                            answerDisplay.style.color = '#3c4043';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        answerDisplay.textContent = 'An error occurred. Please try again.';
                        answerDisplay.style.color = '#d90000';
                    });
                });
            });
            
        });
    </script>

</body>
</html>
